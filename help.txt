"use strict";

const { dbHelper } = require("../../../helper");
const httpStatus = require("http-status");
const hashHelper = require("../helpers/hashHelper");
const bcrypt = require("bcrypt");

module.exports = async (email, password) => {
  try {
    let response = {
      status: httpStatus.BAD_REQUEST,
      message: "Login Failed",
    };

    let query = `SELECT * FROM blog.user WHERE email = ?`;
    const [result] = await dbHelper.executeQuery(query, [email]);

    if (result.length === 0) {
      return { status: false, message: "User not found" };
    }

    const user = result[0];
    const hashedPassword = user.password;

    if (!hashedPassword) {
      return { status: false, message: "User has no password" };
    }

    const passwordMatch = await bcrypt.compare(password, hashedPassword);

    if (!passwordMatch) {
      return { status: false, message: "Invalid password" };
    }

    return { status: true, message: "Login Successful", user };
  } catch (error) {
    console.error(error);
    throw new Error("Error retrieving user data");
  }
};
